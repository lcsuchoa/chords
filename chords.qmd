---
title: "chords"
format: html
editor: visual
---

```{r include=F}
# devtools::install_github("r-music/chorrrds")
require(chorrrds)
require(tidyverse)
require(rvest)
require(ggridges)
require(tictoc)
source("utils.R")
```

```{r include=F}
generos <- c("rock", "gospelreligioso", "sertanejo", "mpb", "alternativo",
             "axé", "funk", "pop", "poprock", "samba")

geral <- generos %>%
  purrr::map(~{
    .x %>% 
      paste0("https://www.cifraclub.com.br/mais-acessadas/", .) %>% 
      read_html() %>% 
      html_nodes("a") %>%
      html_attr("href") %>% 
      .[30:119] %>%
      cbind.data.frame(url = ., 
                       genre = .x,
                       ranking = 1:90)
  }) %>%
  purrr::reduce(rbind) %>%
  mutate(genre = gsub("gospelreligioso", "gospel", genre))

geral$artist <- sub("^/(.*?)/.*$", "\\1", geral$url) %>%
  gsub("-", " ", .) %>%
  gsub("(^|\\s)([a-z])", "\\1\\U\\2", ., perl=T)

geral$song <- sub("^/.*?/(.*)/$", "\\1", geral$url) %>%
  gsub("-", " ", .) %>%
  gsub("(^|\\s)([a-z])", "\\1\\U\\2", ., perl=T)
```

```{r include=F}
# esse chunk demora bastante para rodar
tic()
chords <- read_chords(geral)
toc()
```

```{r include=F}
chords <- transpose_capo(chords)
```

```{r}
chords <- transpose_chords(chords)
```


# Análise exploratória sem padronização de tom

#### Top 20 músicas com mais acordes distintos

```{r warning=F}
chords %>% 
  group_by(song, chord) %>% 
  summarise(distintos = n_distinct(chord)) %>% 
  summarise(cont = n()) %>% 
  mutate(song = fct_reorder(song, cont)) %>% 
  top_n(n = 20) %>% 
  ggplot(aes(y = cont, x = song)) +
  geom_bar(colour = 'dodgerblue4', fill = 'darksalmon',
           size = 0.5, alpha = 0.6, stat = "identity") +
  labs(x = 'Songs', y = 'Counts') +
  coord_flip() +
  theme_bw(14)
```

<br>

#### Top 3 acordes mais frequentes por música

```{r warning=F}
chords %>% 
  group_by(song) %>% 
  count(chord) %>%
  mutate(prop = scales::percent(n/sum(n))) %>%
  top_n(n, n = 3) %>%
  arrange(song, desc(n))
```

<br>

#### Top 2 transições mais frequentes por música

```{r warning=F}
chords %>%
  split(.$song) %>% 
  map(chords_ngram, n = 2) %>% 
  bind_rows() %>% 
  group_by(song) %>% 
  count(chords_ngram) %>% 
  mutate(prop = scales::percent(n/sum(n))) %>%
  top_n(n, n = 2) %>%
  arrange(song, desc(n))
```

<br>

#### [WIP] Densidade de extracted features

```{r warning=F}
feat_chords <- chords %>%
  select(chord, song) %>% 
  feature_extraction() %>% 
  select(-chord) %>% 
  group_by(song) %>% 
  summarise_all(mean)

dt <- feat_chords %>% 
  gather(group, vars, minor, seventh, 
         seventh_M, sixth, fifth_dim, fifth_aug, 
         fourth, ninth, bass, dimi, augm)

dt$group <- forcats::lvls_revalue(
  dt$group,
  c("Augmented", "Bass", "Diminished",
    "Augm. Fifth", "Dimi. Fifth",
    "Fourth", "Minor", "Ninth", "Seventh",
    "Major Seventh", "Sixth"))

dt %>% 
  ggplot(aes(vars, group, fill = group)) +
  geom_density_ridges(alpha = 0.6) +
  scale_fill_cyclical(values = c("dodgerblue4", "darksalmon")) +
  guides(fill = FALSE) +
  xlim(0, 1) +
  labs(x = "Densities", y = "extracted features") +
  theme_bw(14)
```

<br>

#### Quantidade média de acordes distintos por gênero

```{r warning=F}
aux <- chords %>% 
  group_by(song, chord) %>% 
  summarise(distintos = n_distinct(chord)) %>% 
  summarise(cont = n()) %>% 
  mutate(song = fct_reorder(song, cont))

left_join(aux, geral, by="song") %>%
  group_by(genre) %>%
  na.omit() %>%
  summarise(cont = round(mean(cont), 2)) %>%
  ggplot(aes(y = cont, reorder(genre, -cont, decreasing=T))) +
  geom_bar(colour = 'dodgerblue4', fill = 'darksalmon',
           size = 0.5, alpha = 0.6, stat = "identity") +
  labs(x = 'genres', y = 'Counts') +
  coord_flip() +
  theme_bw(14)
```

<br>

#### Top 5 acordes mais frequentes por gênero

```{r warning=F}
aux <- chords %>%
  group_by(song) %>% 
  count(chord)

left_join(aux, geral, by="song") %>%
  group_by(genre) %>%
  na.omit() %>%
  count(chord) %>%
  mutate(prop = scales::percent(n/sum(n))) %>%
  top_n(n, n = 5) %>%
  arrange(genre, desc(n))
```

<br>

#### Top 2 transições mais frequentes por gênero

```{r warning=F}
aux <- chords %>%
  split(.$song) %>% 
  map(chords_ngram, n = 2) %>% 
  bind_rows() %>% 
  group_by(song)

left_join(aux, geral, by="song") %>% 
  group_by(genre) %>%
  na.omit() %>%
  count(chords_ngram) %>%
  mutate(prop = scales::percent(n/sum(n), 2)) %>%
  top_n(n, n = 2) %>%
  arrange(genre, desc(n))
```

<br>

#### Top 2 progressões mais frequentes por gênero

```{r warning=F}
aux <- chords %>%
  split(.$song) %>% 
  map(chords_ngram, n = 4) %>% 
  bind_rows() %>% 
  group_by(song)

left_join(aux, geral, by="song") %>% 
  group_by(genre) %>%
  na.omit() %>%
  count(chords_ngram) %>%
  mutate(prop = scales::percent(n/sum(n), 2)) %>%
  top_n(n, n = 2) %>%
  arrange(genre, desc(n))
```

<br>

#### Top 2 tonalidades mais frequentes por gênero

```{r warning=F}
aux <- chords %>%
  group_by(song) %>%
  count(key)

left_join(aux, geral, by="song") %>% 
  group_by(genre) %>%
  na.omit() %>%
  count(key) %>% 
  mutate(prop = scales::percent(n/sum(n), 2)) %>%
  top_n(n, n = 2) %>%
  arrange(genre, desc(n))
```

<br>

#### [WIP] Proporção de acordes maiores e menores por gênero

```{r warning=F}
aux <- chords %>%
  select(chord, song) %>% 
  feature_extraction() %>% 
  select(-chord) %>% 
  group_by(song) %>% 
  summarise_all(mean)

left_join(aux, geral, by="song") %>% 
  group_by(genre) %>%
  na.omit() %>%
  summarise(minor = round(mean(minor), 2)) %>%
  mutate(major = 1 - minor) %>%
  arrange(desc(minor))
```

<br>

#### [WIP] Proporção de acordes simples e complexos por gênero

```{r warning=F}
aux <- chords %>%
  select(chord, song) %>% 
  feature_extraction() %>% 
  select(-chord) %>% 
  group_by(song) %>% 
  summarise_all(mean) %>%
  mutate(complex = dimi + augm + sus + seventh + seventh_M + sixth + fourth +
           sixth + fourth + fifth_aug + fifth_dim + ninth + bass)

left_join(aux, geral, by="song") %>% 
  group_by(genre) %>%
  na.omit() %>%
  summarise(complex = round(mean(complex), 2)) %>%
  mutate(simple = 1 - complex) %>%
  arrange(desc(complex))
```

<br>

## Análise exploratória com padronização de tom

```{r include=F}
chords <- chords %>%
  mutate(chordC = transpose_chords(chords, "C")) %>%
  mutate(keyC = ifelse(grepl("m", key), "Am", "C"), key)
```

```{r}
chords <- transpose_chords(chords)
```


#### Quantidade de acordes distintos por gênero

```{r}
aux <- chords %>% 
  group_by(song, chordC) %>% 
  summarise(distintos = n_distinct(chordC)) %>% 
  summarise(cont = n()) %>% 
  mutate(song = fct_reorder(song, cont))

left_join(aux, geral, by="song") %>%
  group_by(genre) %>%
  na.omit() %>%
  summarise(cont = round(mean(cont), 2)) %>%
  ggplot(aes(y = cont, reorder(genre, -cont, decreasing=T))) +
  geom_bar(colour = 'dodgerblue4', fill = 'darksalmon',
           size = 0.5, alpha = 0.6, stat = "identity") +
  labs(x = 'genres', y = 'Counts') +
  coord_flip() +
  theme_bw(14)
```

<br>

#### Top 5 acordes mais frequentes por gênero

```{r}
aux <- chords %>%
  group_by(song) %>% 
  count(chordC)

left_join(aux, geral, by="song") %>%
  group_by(genre) %>%
  na.omit() %>%
  count(chordC) %>%
  mutate(prop = scales::percent(n/sum(n))) %>%
  top_n(n, n = 5)
```

<br>

```{r include=F}
chordsC <- chords %>%
  mutate(chord = chordC) %>%
  mutate(key = keyC)
```

#### Top 2 transições mais frequentes por gênero

```{r}
aux <- chordsC %>%
  split(.$song) %>% 
  map(chords_ngram, n = 2) %>% 
  bind_rows() %>% 
  group_by(song)

left_join(aux, geral, by="song") %>% 
  group_by(genre) %>%
  na.omit() %>%
  count(chords_ngram) %>%
  mutate(prop = scales::percent(n/sum(n), 2)) %>%
  top_n(n, n = 2) %>%
  arrange(genre, desc(n))
```

<br>

#### Top 2 progressões mais frequentes por gênero

```{r}
aux <- chordsC %>%
  split(.$song) %>% 
  map(chords_ngram, n = 4) %>% 
  bind_rows() %>% 
  group_by(song)

left_join(aux, geral, by="song") %>% 
  group_by(genre) %>%
  na.omit() %>%
  count(chords_ngram) %>%
  mutate(prop = scales::percent(n/sum(n), 2)) %>%
  top_n(n, n = 2) %>%
  arrange(genre, desc(n))
```

